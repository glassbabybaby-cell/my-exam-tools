<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”ŸåŒ–åˆ·é¡Œç¥å™¨ v4.0 PRO</title>
    <!-- å¼•å…¥ Tailwind CSSï¼šè² è²¬æ¼‚äº®çš„ä»‹é¢ (æ’ç‰ˆã€é¡è‰²) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Font Awesomeï¼šè² è²¬åœ–ç¤º (åƒæ˜¯çç›ƒã€æ™‚é˜ã€é½’è¼ª) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* æ·¡å…¥å‹•ç•«ï¼šè®“ç•«é¢åˆ‡æ›æ™‚ä¸è¦å¤ªçªå…€ */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* æŠ–å‹•å‹•ç•«ï¼šç­”éŒ¯æ™‚æœƒéœ‡å‹•ä¸€ä¸‹ */
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* æŒ‰éˆ•ç¸®æ”¾ï¼šæŒ‰ä¸‹å»æœ‰åé¥‹æ„Ÿ */
        .btn-active:active { transform: scale(0.95); transition: 0.1s; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col">

    <!-- ä¸» App å®¹å™¨ï¼šé™åˆ¶åœ¨æ‰‹æ©Ÿå¯¬åº¦ï¼Œç½®ä¸­é¡¯ç¤º -->
    <div id="app" class="max-w-md mx-auto w-full min-h-screen bg-white shadow-2xl flex flex-col relative overflow-hidden">
        
        <!-- é ‚éƒ¨é¸å–®æ¬„ (Header) -->
        <header class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg z-20">
            <div class="flex items-center gap-2 cursor-pointer" onclick="renderHome()">
                <div class="bg-gradient-to-tr from-yellow-400 to-yellow-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-black">P</div>
                <h1 class="font-bold text-lg">åˆ·é¡Œç¥å™¨ <span class="text-[10px] bg-yellow-500 text-black px-1 rounded">V4.0</span></h1>
            </div>
            <div class="flex gap-2">
                <!-- é½’è¼ªæŒ‰éˆ•ï¼šé‡ç½®æ‰€æœ‰è³‡æ–™ç”¨ -->
                <button onclick="confirmReset()" class="text-slate-400 hover:text-white px-2"><i class="fas fa-cog"></i></button>
                <!-- éŒ¯é¡Œæœ¬æŒ‰éˆ•ï¼šç›´æ¥è·³è½‰åˆ°æ’è¡Œæ¦œ -->
                <button onclick="showLeaderboard()" class="text-xs bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5 rounded-full shadow-lg">
                    <i class="fas fa-list-ol"></i> æ’è¡Œæ¦œ
                </button>
            </div>
        </header>

        <!-- å…§å®¹é¡¯ç¤ºå€åŸŸ (æœƒè¢« JavaScript å‹•æ…‹æ›¿æ›) -->
        <main id="content-area" class="flex-grow flex flex-col relative overflow-y-auto bg-slate-50">
            <!-- åˆå§‹åŠ è¼‰ä¸­ -->
        </main>

    </div>

    <script>
        // ==========================================
        // 1. ã€é¡Œåº«è³‡æ–™åº«ã€‘ é€™æ˜¯ä½ è¦æ”¹é¡Œç›®çš„åœ°æ–¹ï¼
        // ==========================================
        // è¦å‰‡ï¼šid ä¸èƒ½é‡è¤‡ã€‚options[0] å¿…é ˆæ˜¯æ­£ç¢ºç­”æ¡ˆ (ç¨‹å¼æœƒè‡ªå‹•å¹«ä½ æ´—ç‰Œ)ã€‚
        const questionBank = [
            { id: "ch3_1", chapter: "Ch3", q: "ä¸‹åˆ—ä½•è€…ç‚ºä¸­æ€§èƒºåŸºé…¸ï¼Ÿ", options: ["ç”˜èƒºé…¸ (Glycine)", "é›¢èƒºé…¸ (Lysine)", "çµ„èƒºé…¸ (Histidine)", "éº©èƒºé…¸ (Glutamic acid)"], rationale: "Glycine çš„ R åŸºåªæœ‰ä¸€å€‹ Hï¼Œéæ¥µæ€§ä¸­æ€§ã€‚Lys/His æ˜¯é¹¼æ€§ï¼ŒGlu æ˜¯é…¸æ€§ã€‚" },
            { id: "ch3_45", chapter: "Ch3", q: "é®åˆ€å‹è²§è¡€æ˜¯ Glutamate è¢«èª°å–ä»£ï¼Ÿ", options: ["Valine (çºˆèƒºé…¸)", "Glycine", "Lysine", "Alanine"], rationale: "æ¥µæ€§çš„ Glu è®Šæˆäº†ç–æ°´çš„ Valï¼Œå°è‡´è¡€ç´…ç´ èšåˆã€‚è¨˜å¾—ï¼šSickle = Valineã€‚" },
            { id: "ch3_12", chapter: "Ch3", q: "è† åŸè›‹ç™½ (Collagen) çš„çµæ§‹æ•˜è¿°ï¼Œä½•è€…éŒ¯èª¤ï¼Ÿ", options: ["å½¢æˆå·¦æ‰‹å‹çš„è¶…æ—‹é«”", "äººé«”å«é‡æœ€è±å¯Œ", "Gly èˆ‡ Pro å«é‡é«˜", "æ¯ä¸‰æ®˜åŸºå‡ºç¾ä¸€å€‹ Gly"], rationale: "è† åŸè›‹ç™½æ•´é«”æ˜¯ã€Œå³æ‰‹ã€è¶…èºæ—‹ï¼å–®è‚¡æ‰æ˜¯å·¦æ‰‹ã€‚" },
            { id: "ch3_41", chapter: "Ch3", q: "å“ªç¨®è©¦åŠ‘æœƒç ´å£ã€Œé›™ç¡«éµã€ï¼Ÿ", options: ["Î²-mercaptoethanol", "å°¿ç´ ", "SDS", "ç¶­ç”Ÿç´  C"], rationale: "Î²-mercaptoethanol æ˜¯é‚„åŸåŠ‘ï¼Œå°ˆé–€å‰ªæ–·é›™ç¡«éµã€‚å°¿ç´ æ˜¯ç ´å£æ°«éµã€‚" },
            { id: "ch4_1", chapter: "Ch4", q: "Michaelis constant (Km) è¶Šå¤§ä»£è¡¨ï¼Ÿ", options: ["è¦ªå’ŒåŠ›è¶Šå°", "è¦ªå’ŒåŠ›è¶Šå¤§", "åæ‡‰é€Ÿç‡è¶Šå¿«", "é…µç´ é‡è¶Šå¤š"], rationale: "Km èˆ‡è¦ªå’ŒåŠ›æˆåæ¯”ã€‚Km è¶Šå¤§ï¼Œä»£è¡¨è¦è¶Šå¤šå—è³ªæ‰èƒ½é”åˆ°åŠé€Ÿï¼Œè¦ªå’ŒåŠ›ä½ã€‚" },
            { id: "ch7_8", chapter: "Ch7", q: "ä¸‰é…¸ç”˜æ²¹é…¯ (TG) ä½”æ¯”æœ€é«˜çš„è„‚è›‹ç™½æ˜¯ï¼Ÿ", options: ["Chylomicrons (CM)", "VLDL", "LDL", "HDL"], rationale: "ä¹³ç³œå¾®ç²’ CM è² è²¬é‹é€é£Ÿç‰©ä¸­çš„æ²¹è„‚ï¼ŒTG å«é‡é«˜é” 90%ã€‚" },
            { id: "ch7_1", chapter: "Ch7", q: "å“ªä¸€å€‹ä¸æ˜¯ã€Œå¿…éœ€ã€è„‚è‚ªé…¸ï¼Ÿ", options: ["æ²¹é…¸ (Oleic acid)", "äºéº»æ²¹é…¸", "æ¬¡äºéº»æ²¹é…¸", "DHA (å¯ç”±å‰å…©è€…åˆæˆ)"], rationale: "æ²¹é…¸äººé«”å¯è‡ªè¡Œåˆæˆã€‚çœŸæ­£çš„å¿…éœ€åªæœ‰äºéº»æ²¹é…¸èˆ‡æ¬¡äºéº»æ²¹é…¸ã€‚" }
            // ä½ å¯ä»¥æŒ‰é€™å€‹æ ¼å¼ç¹¼çºŒå¾€ä¸‹è²¼...
        ];

        // ==========================================
        // 2. ã€ç‹€æ…‹ç®¡ç†ã€‘ è² è²¬è¨˜ä½ä½ çš„é€²åº¦
        // ==========================================
        const DB_KEY = 'biochem_v4_storage';
        let state = {
            doneIds: [],      // å·²ç¶“åˆ·éçš„é¡Œç›® ID
            wrongStats: {},   // éŒ¯é¡Œè¨ˆæ•¸å™¨ï¼š { 'ch3_1': 5 }
            currentBatch: [], // é€™å›åˆçš„é¡Œç›®
            batchIndex: 0,    // ç›®å‰åœ¨é€™ä¸€å›åˆçš„ç¬¬å¹¾é¡Œ
            score: 0          // æœ¬å›åˆå¾—åˆ†
        };

        // å­˜æª”èˆ‡è®€æª”
        function save() { localStorage.setItem(DB_KEY, JSON.stringify(state)); }
        function load() { 
            const data = localStorage.getItem(DB_KEY);
            if (data) state = JSON.parse(data);
        }

        // ==========================================
        // 3. ã€æ ¸å¿ƒé‚è¼¯ã€‘ 
        // ==========================================

        // æ´—ç‰Œå‡½æ•¸ï¼šè®“é¸é …éš¨æ©ŸåŒ– (å½éš¨æ©Ÿ)
        function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

        // é–‹å§‹æ–°å›åˆ (ä¸€å›åˆ10é¡Œ)
        function startNewRound(mode = 'normal') {
            let pool = [];
            
            if (mode === 'wrong_only') {
                // åªåˆ·æœ‰éŒ¯éçš„é¡Œç›®
                const wrongIds = Object.keys(state.wrongStats).filter(id => state.wrongStats[id] > 0);
                pool = questionBank.filter(q => wrongIds.includes(q.id));
                if (pool.length === 0) { alert("ä½ ç›®å‰æ²’æœ‰éŒ¯é¡Œå–”ï¼"); return; }
            } else {
                // åˆ·æ²’åšéçš„é¡Œç›® (ç‰Œçµ„æ¨¡å¼)
                pool = questionBank.filter(q => !state.doneIds.includes(q.id));
                if (pool.length === 0) { renderAllDone(); return; }
            }

            const size = Math.min(10, pool.length);
            const selected = shuffle([...pool]).slice(0, size);

            // è™•ç†é¡Œç›®ï¼šæ´—ç‰Œé¸é …
            state.currentBatch = selected.map(q => {
                const opts = q.options.map((t, i) => ({ text: t, isCorrect: i === 0 }));
                return { ...q, randomOptions: shuffle(opts) };
            });

            state.batchIndex = 0;
            state.score = 0;
            save();
            renderQuiz();
        }

        // ç‰¹åˆ¥ï¼šåªåˆ·å–®ç¨ä¸€é¡Œ (å¾æ’è¡Œæ¦œé»é€²ä¾†)
        function startSingleDrill(id) {
            const q = questionBank.find(x => x.id === id);
            if (!q) return;
            const opts = q.options.map((t, i) => ({ text: t, isCorrect: i === 0 }));
            state.currentBatch = [{ ...q, randomOptions: shuffle(opts) }];
            state.batchIndex = 0;
            state.score = 0;
            renderQuiz();
        }

        // ==========================================
        // 4. ã€UI ç•«é¢ã€‘ 
        // ==========================================
        const view = document.getElementById('content-area');

        // é¦–é 
        function renderHome() {
            load();
            const total = questionBank.length;
            const done = state.doneIds.length;
            const remaining = total - done;

            view.innerHTML = `
                <div class="p-6 flex flex-col items-center justify-center min-h-full space-y-8 fade-in">
                    <div class="text-center">
                        <h2 class="text-3xl font-black text-slate-800 mb-2">æº–å‚™å¥½è¡åˆºäº†å—ï¼Ÿ</h2>
                        <p class="text-slate-500">ç›®å‰é¡Œåº«å‰©é¤˜ï¼š<span class="font-bold text-indigo-600">${remaining}</span> é¡Œ</p>
                    </div>

                    <!-- é€²åº¦æ¢ -->
                    <div class="w-full bg-slate-200 rounded-full h-4 overflow-hidden">
                        <div class="bg-green-500 h-full transition-all duration-1000" style="width: ${(done/total)*100}%"></div>
                    </div>

                    <div class="grid grid-cols-1 w-full gap-4">
                        <button onclick="startNewRound()" class="bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-xl btn-active text-lg">
                            <i class="fas fa-play mr-2"></i> é–‹å§‹æ¨™æº–æ¨¡å¼ (10é¡Œ)
                        </button>
                        <button onclick="startNewRound('wrong_only')" class="bg-slate-800 text-white font-bold py-4 rounded-2xl shadow-xl btn-active text-lg">
                            <i class="fas fa-skull-crossbones mr-2"></i> éŒ¯é¡Œæ®²æ»…æ¨¡å¼
                        </button>
                    </div>
                </div>
            `;
        }

        // é¡Œç›®ç•«é¢
        function renderQuiz() {
            const q = state.currentBatch[state.batchIndex];
            const num = state.batchIndex + 1;
            const total = state.currentBatch.length;

            view.innerHTML = `
                <div class="p-5 flex flex-col h-full fade-in">
                    <div class="flex justify-between text-xs font-bold text-slate-400 mb-4">
                        <span>${q.chapter}</span>
                        <span>PROGRESS: ${num} / ${total}</span>
                    </div>

                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm mb-6">
                        <h2 class="text-xl font-bold text-slate-800 leading-relaxed">${q.q}</h2>
                    </div>

                    <div class="space-y-3 flex-grow" id="options-box">
                        ${q.randomOptions.map((o, i) => `
                            <button onclick="pick(${i})" class="opt-btn w-full text-left p-4 rounded-xl border-2 border-slate-100 hover:border-indigo-400 transition flex gap-3 btn-active bg-white">
                                <div class="w-6 h-6 rounded-full bg-slate-100 text-slate-400 text-xs flex items-center justify-center font-bold">${String.fromCharCode(65+i)}</div>
                                <span class="text-slate-700">${o.text}</span>
                            </button>
                        `).join('')}
                    </div>

                    <div id="feedback" class="hidden mt-6 bg-slate-900 text-white p-5 rounded-2xl fade-in">
                        <div id="result-text" class="font-bold text-lg mb-2"></div>
                        <div id="rationale-text" class="text-slate-400 text-sm mb-4 border-t border-slate-700 pt-2"></div>
                        <button onclick="next()" class="w-full bg-yellow-500 text-black font-bold py-3 rounded-xl">ä¸‹ä¸€é¡Œ â”</button>
                    </div>
                </div>
            `;
        }

        // é¸æ“‡ç­”æ¡ˆ
        function pick(idx) {
            const q = state.currentBatch[state.batchIndex];
            const chosen = q.randomOptions[idx];
            const isCorrect = chosen.isCorrect;

            // ç¦ç”¨æŒ‰éˆ•
            const btns = document.querySelectorAll('.opt-btn');
            btns.forEach(b => b.disabled = true);

            // é¡¯ç¤ºçµæœ
            const feedback = document.getElementById('feedback');
            const res = document.getElementById('result-text');
            const rat = document.getElementById('rationale-text');

            if (isCorrect) {
                state.score++;
                btns[idx].classList.add('border-green-500', 'bg-green-50');
                res.innerHTML = `<span class="text-green-400"><i class="fas fa-check-circle"></i> ç­”å°äº†ï¼</span>`;
                // ç­”å°çš„è©±ï¼Œå¾éŒ¯é¡Œè¨ˆæ•¸æ¸›å°‘ (å¦‚æœä½ å¸Œæœ›ç­”å°å°±ä¸å†ç®—éŒ¯çš„è©±)
                if (state.wrongStats[q.id] > 0) state.wrongStats[q.id]--;
            } else {
                btns[idx].classList.add('border-red-500', 'bg-red-50');
                res.innerHTML = `<span class="text-red-400"><i class="fas fa-times-circle"></i> ç­”éŒ¯äº†ï¼</span>`;
                // æ¨™ç¤ºæ­£ç¢ºç­”æ¡ˆ
                const correctIdx = q.randomOptions.findIndex(o => o.isCorrect);
                btns[correctIdx].classList.add('border-green-500', 'bg-green-50', 'ring-2', 'ring-green-200');
                // å¢åŠ éŒ¯èª¤è¨ˆæ•¸
                state.wrongStats[q.id] = (state.wrongStats[q.id] || 0) + 1;
            }

            // ç„¡è«–å°éŒ¯ï¼Œé€™é¡Œéƒ½ç®—ã€Œçœ‹éäº†ã€ (å¾ç‰Œçµ„ç§»é™¤)
            if (!state.doneIds.includes(q.id)) state.doneIds.push(q.id);

            rat.innerText = q.rationale;
            feedback.classList.remove('hidden');
            save();
        }

        function next() {
            state.batchIndex++;
            if (state.batchIndex < state.currentBatch.length) {
                renderQuiz();
            } else {
                renderHome(); // å®Œæˆå¾Œå›é¦–é ï¼Œæˆ–ä½ å¯ä»¥åšä¸€å€‹çµæœé 
            }
        }

        // éŒ¯é¡Œæ’è¡Œæ¦œ
        function showLeaderboard() {
            const sorted = Object.entries(state.wrongStats)
                .filter(([id, count]) => count > 0)
                .map(([id, count]) => ({ ...questionBank.find(x => x.id === id), count }))
                .sort((a, b) => b.count - a.count);

            const listHtml = sorted.length === 0 
                ? `<div class="text-center py-20 text-slate-400">ç›®å‰æ²’æœ‰éŒ¯é¡Œï¼Œä½ æ˜¯æˆ°ç¥ï¼</div>`
                : sorted.map((q, i) => `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex gap-4 items-center">
                        <div class="w-8 h-8 rounded-lg ${i<3?'bg-red-100 text-red-600':'bg-slate-100 text-slate-400'} flex items-center justify-center font-black">${i+1}</div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">${q.chapter}</span>
                                <span class="text-xs font-bold text-red-500">éŒ¯èª¤ ${q.count} æ¬¡</span>
                            </div>
                            <p class="text-sm font-bold text-slate-700 line-clamp-1">${q.q}</p>
                        </div>
                        <!-- äº’å‹•æŒ‰éˆ•ï¼šç›´æ¥åˆ·é€™ä¸€é¡Œ -->
                        <button onclick="startSingleDrill('${q.id}')" class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-600 hover:text-white transition">
                            <i class="fas fa-bullseye"></i>
                        </button>
                    </div>
                `).join('');

            view.innerHTML = `
                <div class="p-4 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-black text-slate-800">â˜ ï¸ éŒ¯é¡Œæ’è¡Œæ¦œ</h2>
                        <button onclick="renderHome()" class="text-slate-400"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="space-y-3 pb-20">
                        ${listHtml}
                    </div>
                </div>
            `;
        }

        // å…¶ä»–åŠŸèƒ½
        function renderAllDone() {
            view.innerHTML = `
                <div class="p-10 text-center flex flex-col items-center justify-center min-h-full space-y-6 fade-in">
                    <div class="text-7xl">ğŸ†</div>
                    <h2 class="text-3xl font-black">é¡Œåº«å·²æ¸…ç©ºï¼</h2>
                    <p class="text-slate-500">æ‰€æœ‰çš„é¡Œç›®ä½ éƒ½è‡³å°‘åšéä¸€éäº†ã€‚ç¾åœ¨ä½ å¯ä»¥å»è¤‡ç¿’éŒ¯é¡Œï¼Œæˆ–æ˜¯é‡æ–°é–‹å§‹ä¸€è¼ªã€‚</p>
                    <button onclick="confirmReset()" class="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold">é‡ç½®ä¸¦å†ä¾†ä¸€è¼ª</button>
                    <button onclick="renderHome()" class="text-slate-400 underline">å›é¦–é </button>
                </div>
            `;
        }

        function confirmReset() {
            if (confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰é€²åº¦èˆ‡æ’è¡Œæ¦œå—ï¼Ÿé€™æœƒæ¸…é™¤ä½ æ‰€æœ‰çš„å­¸ç¿’è¨˜éŒ„å–”ï¼")) {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        // å•Ÿå‹• App
        init();
    </script>
</body>
</html>
