<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”ŸåŒ–åˆ·é¡Œç¥å™¨ v3.0 PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* å‹•ç•«ç‰¹æ•ˆ */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.9); } 100% { transform: scale(1); } }

        /* PRO å¾½ç« é–ƒå…‰æ•ˆæœ */
        .pro-shine {
            position: relative;
            overflow: hidden;
        }
        .pro-shine::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(to bottom right, rgba(255,255,255,0) 0%, rgba(255,255,255,0) 40%, rgba(255,255,255,0.5) 50%, rgba(255,255,255,0) 60%, rgba(255,255,255,0) 100%);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }
        @keyframes shine { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col">

    <!-- App Container -->
    <div id="app" class="max-w-md mx-auto w-full min-h-screen bg-white shadow-2xl flex flex-col relative overflow-hidden">
        
        <!-- Header -->
        <header class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg z-20">
            <div class="flex items-center gap-2">
                <div class="bg-gradient-to-tr from-yellow-400 to-yellow-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-black shadow-lg">P</div>
                <h1 class="font-bold text-lg tracking-wider">åˆ·é¡Œç¥å™¨ <span class="text-xs bg-yellow-500 text-black px-1.5 py-0.5 rounded font-black">PRO</span></h1>
            </div>
            <div class="flex gap-2">
                <button onclick="resetData()" class="text-slate-400 hover:text-white px-2 transition"><i class="fas fa-cog"></i></button>
                <button onclick="showStats()" class="text-xs bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5 rounded-full transition shadow-lg shadow-indigo-500/30 flex items-center gap-1">
                    <i class="fas fa-chart-bar"></i> éŒ¯é¡Œæœ¬
                </button>
            </div>
        </header>

        <!-- Dynamic Content -->
        <main id="content-area" class="flex-grow flex flex-col relative overflow-y-auto bg-slate-50">
            <!-- é€™è£¡æœƒå‹•æ…‹æ’å…¥å…§å®¹ -->
        </main>

    </div>

    <script>
        // ==========================================
        // 1. é¡Œåº«è¨­å®š (DATA)
        // ==========================================
        // èªªæ˜ï¼štype: 'concept' ä»£è¡¨æ€è€ƒé¡Œï¼Œæ²’æœ‰å¯« type çš„é è¨­ç‚ºä¸€èˆ¬é¡Œ
        // è¨˜å¾—ï¼šoptions[0] æ°¸é æ”¾æ­£ç¢ºç­”æ¡ˆï¼Œç¨‹å¼æœƒè‡ªå‹•æ´—ç‰Œ
        
        const questionBank = [
            // --- Ch3 èƒºåŸºé…¸ ---
            {
                id: "ch3_1", chapter: "Ch3 èƒºåŸºé…¸", type: "basic",
                q: "ä¸‹åˆ—ä½•è€…ç‚ºä¸­æ€§èƒºåŸºé…¸ï¼Ÿ",
                options: ["ç”˜èƒºé…¸ (Glycine)", "é›¢èƒºé…¸ (Lysine)", "çµ„èƒºé…¸ (Histidine)", "éº©èƒºé…¸ (Glutamic acid)"],
                rationale: "Glycine æ˜¯éæ¥µæ€§ä¸­æ€§ï¼›Lys/His æ˜¯é¹¼æ€§ï¼›Glu æ˜¯é…¸æ€§ã€‚"
            },
            {
                id: "ch3_45", chapter: "Ch3 èƒºåŸºé…¸", type: "concept",
                q: "Sickle-cell anemia (é®åˆ€å‹è²§è¡€) æ˜¯è¡€ç´…ç´  Î² éˆç¬¬ 6 ä½çš„ Glutamate è¢«èª°å–ä»£ï¼Œé€ æˆç–æ°´æ€§èšåˆï¼Ÿ",
                options: ["Valine (çºˆèƒºé…¸)", "Glycine (ç”˜èƒºé…¸)", "Lysine (é›¢èƒºé…¸)", "Aspartate (å¤©é–€å†¬èƒºé…¸)"],
                rationale: "Sickle = S-V (Valine)ã€‚é€™æ˜¯ä¸€å€‹ç¶“å…¸çš„ç–æ°´æ€§æ•ˆæ‡‰ä¾‹å­ã€‚"
            },
            {
                id: "ch3_12", chapter: "Ch3 çµæ§‹", type: "concept",
                q: "ã€æ¦‚å¿µé¡Œã€‘æœ‰é—œè† åŸè›‹ç™½ (Collagen) çš„æ•˜è¿°ï¼Œä½•è€… **éŒ¯èª¤**ï¼Ÿ",
                options: ["å½¢æˆå·¦æ‰‹å‹çš„è¶…æ—‹é«”", "äººé«”å«é‡æœ€è±å¯Œçš„è›‹ç™½è³ª", "Gly èˆ‡ Pro å«é‡ç‰¹åˆ¥é«˜", "ä¸¦éå–®ä¸€è›‹ç™½è³ª"],
                rationale: "è† åŸè›‹ç™½æ˜¯ã€Œå³æ‰‹ã€è¶…èºæ—‹ (Right-handed Superhelix)ã€‚å–®è‚¡æ‰æ˜¯å·¦æ‰‹ã€‚"
            },
            {
                id: "ch3_3", chapter: "Ch3 èƒºåŸºé…¸", type: "basic",
                q: "å…©å€‹ Methionine ä¹‹é–“ä¸èƒ½å½¢æˆé›™ç¡«éµï¼Œæ˜¯å› ç‚ºï¼Ÿ",
                options: ["å…¶ç¡«åŸå­å·²è¢«ç”²åŸºåŒ–", "ä¸å…·æœ‰ç¡«åŸå­", "è¼ƒ Cysteine å¤§", "ä½æ–¼ N-terminal"],
                rationale: "Met çš„ç¡«æ¥äº†ç”²åŸº (-S-CH3)ï¼Œæ˜¯ç¡«é†šåŸºï¼Œæ²’æœ‰è‡ªç”±çš„æ‰‹å»ç‰½åˆ¥äººã€‚"
            },
            
            // --- Ch4 é…µç´  ---
            {
                id: "ch4_1", chapter: "Ch4 é…µç´ ", type: "basic",
                q: "æ‰€è¬‚ Michaelis constant (Km) çš„æ„ç¾©ç‚ºä½•ï¼Ÿ",
                options: ["ä»£è¡¨åŸºè³ªå°é…µç´ çš„è¦ªå’Œç¨‹åº¦", "é…µç´ çš„åˆ†å­é‡", "æ¥µæ€§èƒºåŸºé…¸æ¯”ä¾‹", "é…µç´ è®Šæ€§ç¨‹åº¦"],
                rationale: "Km è¶Šå°ï¼Œè¦ªå’ŒåŠ› (Affinity) è¶Šå¤§ã€‚"
            },
            {
                id: "ch4_32", chapter: "Ch4 é…µç´ ", type: "concept",
                q: "é—œæ–¼é…µç´ çš„æ•˜è¿°ï¼Œä¸‹åˆ—ä½•è€… **éŒ¯èª¤**ï¼Ÿ",
                options: ["é…µç´ åƒ…ç”±è›‹ç™½è³ªçµ„æˆ", "æ˜¯ç”Ÿç‰©å‚¬åŒ–åŠ‘", "å¯å¢åŠ åæ‡‰é€Ÿç‡", "ä¸æ”¹è®Šåæ‡‰å¹³è¡¡"],
                rationale: "æœ‰äº›é…µç´ æ˜¯ RNA (Ribozyme)ï¼Œä¸å…¨æ˜¯è›‹ç™½è³ªã€‚"
            },

            // --- Ch7 è„‚è³ª ---
            {
                id: "ch7_8", chapter: "Ch7 è„‚è³ª", type: "basic",
                q: "ä¸‹åˆ—ä½•ç¨®è„‚è›‹ç™½ï¼Œå…¶ä¸‰é…¸ç”˜æ²¹é…¯ (TG) å«é‡æœ€é«˜ï¼Ÿ",
                options: ["Chylomicrons (ä¹³ç³œå¾®ç²’)", "VLDL", "LDL", "HDL"],
                rationale: "CM è² è²¬é‹é€å‰›åƒé€²ä¾†çš„æ²¹ï¼ŒTG å«é‡é«˜é” 85-90%ã€‚"
            },
            {
                id: "ch7_1", chapter: "Ch7 è„‚è³ª", type: "concept",
                q: "ä¸‹åˆ—ä½•è€… **ä¸å±¬æ–¼** çœŸæ­£çš„å¿…éœ€è„‚è‚ªé…¸ï¼ˆäººé«”å®Œå…¨ç„¡æ³•åˆæˆï¼‰ï¼Ÿ",
                options: ["èŠ±ç”Ÿå››çƒ¯é…¸ (Arachidonate)", "äºéº»æ²¹é…¸ (Linoleate)", "Î±-æ¬¡äºéº»æ²¹é…¸", "ä»¥ä¸Šçš†æ˜¯"],
                rationale: "èŠ±ç”Ÿå››çƒ¯é…¸å¯ç”±äºéº»æ²¹é…¸è½‰è®Šè€Œä¾†ï¼Œæ˜¯ã€Œæ¢ä»¶å¼ã€å¿…éœ€ã€‚å”¯äºŒçµ•å°å¿…éœ€çš„æ˜¯äºéº»æ²¹é…¸èˆ‡æ¬¡äºéº»æ²¹é…¸ã€‚"
            }
        ];

        // ==========================================
        // 2. ç‹€æ…‹ç®¡ç† (STATE)
        // ==========================================
        
        const DB_KEY = 'quiz_master_v3_data';
        
        let state = {
            seenIds: [],      // å·²åšéçš„é¡Œç›® ID (ä¸æœƒå†å‡ºç¾ï¼Œé™¤éé‡ç½®)
            wrongCounts: {},  // { 'ch3_1': 5 } éŒ¯é¡Œçµ±è¨ˆ
            currentMode: '',  // 'quick', 'concept', 'pro_wrong'
            currentBatch: [], // ç›®å‰å›åˆé¡Œç›®
            batchIndex: 0,
            score: 0
        };

        function loadState() {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) state = { ...state, ...JSON.parse(saved) };
        }

        function saveState() {
            localStorage.setItem(DB_KEY, JSON.stringify(state));
        }

        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        // ==========================================
        // 3. éŠæˆ²é‚è¼¯ (LOGIC)
        // ==========================================

        function startMode(mode) {
            let pool = [];
            
            if (mode === 'quick') {
                // å¿«æ·æ¨¡å¼ï¼šæ‰€æœ‰æ²’åšéçš„é¡Œç›®
                pool = questionBank.filter(q => !state.seenIds.includes(q.id));
            } 
            else if (mode === 'concept') {
                // æ€è€ƒæ¨¡å¼ï¼šåªé¸ type='concept' ä¸”æ²’åšéçš„é¡Œç›®
                // å¦‚æœä¸å¤ ï¼Œå‰‡æ”¾å¯¬æ¨™æº–
                pool = questionBank.filter(q => q.type === 'concept' && !state.seenIds.includes(q.id));
                if (pool.length < 3) pool = questionBank.filter(q => !state.seenIds.includes(q.id)); 
            }
            else if (mode === 'pro_wrong') {
                // PRO éŒ¯é¡Œæ¨¡å¼ï¼šå¾ wrongCounts è£¡æŠ“å‡ºæ¬¡æ•¸ > 0 çš„é¡Œç›®
                const wrongIds = Object.keys(state.wrongCounts).filter(id => state.wrongCounts[id] > 0);
                pool = questionBank.filter(q => wrongIds.includes(q.id));
                
                if (pool.length === 0) {
                    alert("å¤ªå¼·äº†ï¼ç›®å‰æ²’æœ‰éŒ¯é¡Œç´€éŒ„ï¼");
                    return;
                }
            }

            if (pool.length === 0 && mode !== 'pro_wrong') {
                // é¡Œåº«åˆ·å®Œäº†
                renderAllClear();
                return;
            }

            // è¨­å®šå›åˆï¼šæœ€å¤š 10 é¡Œ
            const batchSize = Math.min(10, pool.length);
            const selectedQs = shuffle(pool).slice(0, batchSize);

            // è™•ç†é¸é …éš¨æ©ŸåŒ–
            state.currentBatch = selectedQs.map(q => {
                let randomizedOpts = q.options.map((text, idx) => ({ text, isCorrect: idx === 0 }));
                return { ...q, randomOptions: shuffle(randomizedOpts) };
            });

            state.currentMode = mode;
            state.batchIndex = 0;
            state.score = 0;
            saveState();
            renderQuestion();
        }

        // ==========================================
        // 4. ç•«é¢æ¸²æŸ“ (VIEW)
        // ==========================================

        const content = document.getElementById('content-area');

        function init() {
            loadState();
            if (state.currentBatch.length > 0 && state.batchIndex < state.currentBatch.length) {
                renderQuestion(); // æ¢å¾©ä¸Šæ¬¡æœªå®Œæˆçš„è€ƒè©¦
            } else {
                renderHome();
            }
        }

        // é¦–é 
        function renderHome() {
            const total = questionBank.length;
            const done = state.seenIds.length;
            const remaining = total - done;
            const wrongCount = Object.keys(state.wrongCounts).length;

            content.innerHTML = `
                <div class="flex flex-col p-6 space-y-6 fade-in pb-20">
                    
                    <!-- ç”¨æˆ¶ç‹€æ…‹å¡ -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex justify-between items-center">
                        <div>
                            <div class="text-xs text-slate-400 uppercase font-bold">é¡Œåº«é€²åº¦</div>
                            <div class="text-2xl font-black text-slate-800">${done} <span class="text-sm text-slate-400 font-normal">/ ${total}</span></div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-400 uppercase font-bold">å¾…åˆ·éŒ¯é¡Œ</div>
                            <div class="text-2xl font-black text-red-500">${wrongCount}</div>
                        </div>
                    </div>

                    <!-- æ¨¡å¼é¸æ“‡ -->
                    <h2 class="text-slate-400 text-xs font-bold uppercase tracking-wider ml-1">é¸æ“‡æŒ‘æˆ°æ¨¡å¼</h2>
                    
                    <!-- 1. å¿«æ·æ¨¡å¼ -->
                    <button onclick="startMode('quick')" class="group relative bg-white p-5 rounded-2xl shadow-sm border-2 border-transparent hover:border-blue-400 transition-all text-left flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl group-hover:scale-110 transition"><i class="fas fa-bolt"></i></div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-lg">å¿«æ·åˆ·é¡Œ</h3>
                            <p class="text-xs text-slate-500">éš¨æ©Ÿ 10 é¡Œ â€¢ å¿«é€Ÿéé—œ</p>
                        </div>
                    </button>

                    <!-- 2. æ€è€ƒæ¨¡å¼ -->
                    <button onclick="startMode('concept')" class="group relative bg-white p-5 rounded-2xl shadow-sm border-2 border-transparent hover:border-purple-400 transition-all text-left flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xl group-hover:scale-110 transition"><i class="fas fa-brain"></i></div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-lg">æ€è€ƒæ¨¡å¼</h3>
                            <p class="text-xs text-slate-500">æ¦‚å¿µè®Šå½¢é¡Œ â€¢ æ·±åº¦è¤‡ç¿’</p>
                        </div>
                    </button>

                    <!-- 3. PRO æ¨¡å¼ -->
                    <button onclick="startMode('pro_wrong')" class="pro-shine group relative bg-gradient-to-r from-slate-800 to-slate-900 p-5 rounded-2xl shadow-xl shadow-slate-500/20 text-left flex items-center gap-4 border border-slate-700">
                        <div class="w-12 h-12 rounded-full bg-yellow-500 text-black flex items-center justify-center text-xl font-bold group-hover:rotate-12 transition"><i class="fas fa-crown"></i></div>
                        <div class="text-white">
                            <h3 class="font-bold text-lg flex items-center gap-2">PRO éŒ¯é¡Œç‰¹è¨“ <span class="text-[10px] bg-yellow-500 text-black px-1 rounded font-black">VIP</span></h3>
                            <p class="text-xs text-slate-400">å°ˆæ”»ä½ çš„å¼±é» â€¢ ç›´åˆ°å…¨å°</p>
                        </div>
                    </button>

                </div>
            `;
        }

        // é¡Œç›®ä»‹é¢
        function renderQuestion() {
            const q = state.currentBatch[state.batchIndex];
            const currentQNum = state.batchIndex + 1;
            const total = state.currentBatch.length;
            
            let badgeColor = "bg-slate-100 text-slate-500";
            if (state.currentMode === 'pro_wrong') badgeColor = "bg-red-100 text-red-600";
            if (state.currentMode === 'concept') badgeColor = "bg-purple-100 text-purple-600";

            content.innerHTML = `
                <div class="flex flex-col min-h-full p-5 fade-in">
                    <!-- Progress -->
                    <div class="w-full bg-slate-200 h-1.5 rounded-full mb-6">
                        <div class="bg-indigo-600 h-full rounded-full transition-all duration-300" style="width: ${(currentQNum/total)*100}%"></div>
                    </div>

                    <!-- Question -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl text-slate-300 -z-0 pointer-events-none font-black italic">Q${currentQNum}</div>
                        <span class="text-xs font-bold px-2 py-1 rounded mb-3 inline-block ${badgeColor}">${q.chapter}</span>
                        <h2 class="text-xl font-bold text-slate-800 leading-relaxed relative z-10">${q.q}</h2>
                    </div>

                    <!-- Options -->
                    <div class="space-y-3 flex-grow">
                        ${q.randomOptions.map((opt, idx) => `
                            <button onclick="handleAnswer(${idx})" class="option-btn w-full text-left p-4 rounded-xl bg-white border-2 border-slate-100 hover:border-indigo-500 hover:bg-indigo-50 active:scale-98 transition group flex items-start gap-3 shadow-sm">
                                <div class="mt-0.5 w-6 h-6 rounded-full border-2 border-slate-200 text-slate-400 text-xs font-bold flex items-center justify-center group-hover:border-indigo-500 group-hover:text-indigo-500 transition">${String.fromCharCode(65+idx)}</div>
                                <span class="text-slate-700 font-medium group-hover:text-indigo-700">${opt.text}</span>
                            </button>
                        `).join('')}
                    </div>

                    <!-- Feedback Panel -->
                    <div id="feedback-panel" class="hidden mt-6 bg-slate-800 text-white p-5 rounded-2xl shadow-lg pop">
                        <div id="feedback-header" class="font-bold text-lg mb-2 flex items-center gap-2"></div>
                        <div id="feedback-body" class="text-slate-300 text-sm mb-4 leading-relaxed border-t border-slate-700 pt-2"></div>
                        <button onclick="nextQuestion()" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 rounded-xl transition">ä¸‹ä¸€é¡Œ</button>
                    </div>
                </div>
            `;
        }

        function handleAnswer(idx) {
            const q = state.currentBatch[state.batchIndex];
            const isCorrect = q.randomOptions[idx].isCorrect;
            
            // è¨˜éŒ„å·²çœ‹é (æ™®é€šæ¨¡å¼ä¸‹)
            if (state.currentMode !== 'pro_wrong' && !state.seenIds.includes(q.id)) {
                state.seenIds.push(q.id);
            }

            // é–å®šæŒ‰éˆ•
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'grayscale');
            });

            // é¡¯ç¤ºåé¥‹
            const btns = document.querySelectorAll('.option-btn');
            const feedbackPanel = document.getElementById('feedback-panel');
            const header = document.getElementById('feedback-header');
            
            if (isCorrect) {
                state.score++;
                btns[idx].classList.remove('opacity-50', 'grayscale', 'border-slate-100');
                btns[idx].classList.add('bg-green-100', 'border-green-500', 'ring-2', 'ring-green-200');
                header.innerHTML = `<i class="fas fa-check-circle text-green-400"></i> ç­”å°äº†ï¼`;
                
                // å¦‚æœæ˜¯éŒ¯é¡Œæ¨¡å¼ä¸”ç­”å°äº†ï¼Œå¯ä»¥è€ƒæ…®æŠŠéŒ¯é¡Œæ¬¡æ•¸æ¸› 1 (é€™è£¡è¨­è¨ˆç‚ºåªè¦ç­”å°ä¸€æ¬¡å°±ç®—é€šé)
                if (state.currentMode === 'pro_wrong') {
                    // é¸é …ï¼šç­”å°æ˜¯å¦å¾éŒ¯é¡Œæœ¬ç§»é™¤ï¼Ÿé€™è£¡æˆ‘å€‘è¨­å®šç‚ºã€Œæ¸›å°‘ä¸€æ¬¡éŒ¯èª¤è¨ˆæ•¸ã€
                    // è‹¥è¦åš´æ ¼ä¸€é»ï¼Œå¯ä»¥ä¸æ¸›ï¼Œç›´åˆ°ä½¿ç”¨è€…æ‰‹å‹•æ¸…ã€‚
                    // é€™è£¡æˆ‘å€‘è®“ä»–æœ‰æˆå°±æ„Ÿï¼šç­”å°å°±æ‰£åˆ†
                    if (state.wrongCounts[q.id] > 0) state.wrongCounts[q.id]--;
                }

            } else {
                btns[idx].classList.remove('opacity-50', 'grayscale', 'border-slate-100');
                btns[idx].classList.add('bg-red-100', 'border-red-500');
                
                // æ¨™ç¤ºæ­£è§£
                const correctIdx = q.randomOptions.findIndex(o => o.isCorrect);
                btns[correctIdx].classList.remove('opacity-50', 'grayscale', 'border-slate-100');
                btns[correctIdx].classList.add('bg-green-100', 'border-green-500');

                header.innerHTML = `<i class="fas fa-times-circle text-red-400"></i> å“å‘€éŒ¯äº†...`;
                
                // è¨˜éŒ„éŒ¯é¡Œ
                state.wrongCounts[q.id] = (state.wrongCounts[q.id] || 0) + 1;
            }

            document.getElementById('feedback-body').innerText = q.rationale;
            feedbackPanel.classList.remove('hidden');
            feedbackPanel.scrollIntoView({ behavior: 'smooth' });
            
            saveState();
        }

        function nextQuestion() {
            state.batchIndex++;
            if (state.batchIndex < state.currentBatch.length) {
                renderQuestion();
            } else {
                renderResult();
            }
            saveState();
        }

        function renderResult() {
            state.currentBatch = []; // æ¸…ç©ºç•¶å‰æ‰¹æ¬¡
            saveState();

            content.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-full p-6 text-center fade-in">
                    <div class="text-6xl mb-4 transform hover:scale-110 transition cursor-default">ğŸ‰</div>
                    <h2 class="text-2xl font-black text-slate-800 mb-2">å›åˆçµæŸ</h2>
                    <p class="text-slate-500 mb-8">å¤§è…¦ä¼‘æ¯ä¸€ä¸‹ï¼Œè¨˜æ†¶æ­£åœ¨å›ºåŒ–...</p>

                    <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-100 w-full max-w-sm mb-8">
                        <div class="text-sm text-slate-400 font-bold uppercase">æœ¬æ¬¡å¾—åˆ†</div>
                        <div class="text-6xl font-black text-indigo-600 my-2">${state.score}</div>
                        <div class="text-sm bg-indigo-50 text-indigo-600 inline-block px-3 py-1 rounded-full font-bold">æº–ç¢ºç‡ ${state.score * 10}%</div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 w-full">
                        <button onclick="startMode('${state.currentMode}')" class="bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-indigo-700 transition">
                            <i class="fas fa-redo mr-2"></i>å†ä¾†ä¸€å±€
                        </button>
                        <button onclick="renderHome()" class="bg-white text-slate-600 py-4 rounded-2xl font-bold border border-slate-200 hover:bg-slate-50 transition">
                            å›é¦–é 
                        </button>
                    </div>
                </div>
            `;
        }

        // éŒ¯é¡Œæ’è¡Œæ¦œ & äº’å‹•
        function showStats() {
            const wrongList = Object.entries(state.wrongCounts)
                .filter(([id, count]) => count > 0)
                .map(([id, count]) => {
                    const q = questionBank.find(x => x.id === id);
                    return { ...q, count };
                })
                .sort((a, b) => b.count - a.count);

            const listHtml = wrongList.length === 0 
                ? `<div class="text-center text-slate-400 py-20 flex flex-col items-center"><i class="fas fa-check-circle text-4xl mb-4 text-green-300"></i><p>å¤ªå¼·äº†ï¼æ²’æœ‰éŒ¯é¡Œç´€éŒ„</p></div>` 
                : wrongList.map((item, idx) => `
                    <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex gap-4 items-start relative overflow-hidden group">
                        <div class="absolute left-0 top-0 bottom-0 w-1 ${idx < 3 ? 'bg-red-500' : 'bg-slate-300'}"></div>
                        <div class="flex-shrink-0 w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center font-bold text-slate-500 mt-1">${idx + 1}</div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded uppercase">${item.chapter}</span>
                                <span class="text-xs font-bold text-red-500"><i class="fas fa-times mr-1"></i>${item.count}æ¬¡</span>
                            </div>
                            <p class="text-sm font-bold text-slate-700 line-clamp-2 group-hover:text-indigo-600 transition">${item.q}</p>
                        </div>
                    </div>
                `).join('');

            content.innerHTML = `
                <div class="flex flex-col min-h-full bg-slate-50 fade-in">
                    <div class="bg-white p-4 shadow-sm border-b border-slate-200 sticky top-0 z-10 flex justify-between items-center">
                        <h2 class="font-black text-lg text-slate-800"><i class="fas fa-clipboard-list text-indigo-500 mr-2"></i>éŒ¯é¡Œæœ¬</h2>
                        <button onclick="renderHome()" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center hover:bg-slate-200"><i class="fas fa-times"></i></button>
                    </div>
                    
                    <div class="p-4 space-y-3 flex-grow">
                        ${wrongList.length > 0 ? `
                            <div class="bg-red-50 border border-red-100 p-4 rounded-xl flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="font-bold text-red-800">å…‹æœå¼±é»</h3>
                                    <p class="text-xs text-red-600">å…±æœ‰ ${wrongList.length} é¡Œå¾…è¤‡ç¿’</p>
                                </div>
                                <button onclick="startMode('pro_wrong')" class="bg-red-500 hover:bg-red-600 text-white text-sm font-bold px-4 py-2 rounded-lg shadow-lg shadow-red-500/30 transition">
                                    ç«‹å³æŒ‘æˆ°
                                </button>
                            </div>
                        ` : ''}
                        ${listHtml}
                    </div>
                </div>
            `;
        }

        function renderAllClear() {
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-full p-6 text-center fade-in">
                    <div class="text-6xl mb-4">ğŸ†</div>
                    <h2 class="text-3xl font-black text-slate-800 mb-2">åˆ¶éœ¸é”æˆï¼</h2>
                    <p class="text-slate-500 mb-8">é¡Œåº«è£¡çš„æ‰€æœ‰é¡Œç›®ä½ éƒ½åšéä¸€éäº†ï¼</p>
                    <button onclick="resetData()" class="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold">é‡ç½®é€²åº¦ (å†ä¾†ä¸€è¼ª)</button>
                    <button onclick="renderHome()" class="mt-4 text-slate-400 text-sm">å›é¦–é </button>
                </div>
            `;
        }

        function resetData() {
            if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰é€²åº¦å—ï¼Ÿï¼ˆéŒ¯é¡Œç´€éŒ„ä¹Ÿæœƒæ¸…ç©ºï¼‰")) {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        init();
    </script>
</body>
</html>
```
