<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”ŸåŒ–åŸé¡Œçµ‚æ¥µè¡åˆº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .btn-active:active { transform: scale(0.98); }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="font-black text-lg tracking-tight">ğŸ§¬ ç”ŸåŒ–åŸé¡Œçµ‚æ¥µè¡åˆº</h1>
                <p class="text-xs opacity-80" id="global-progress">é€²åº¦ï¼š0 / 122</p>
            </div>
            <button onclick="toggleStats()" class="bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded-xl text-sm font-bold transition">
                ğŸ“Š éŒ¯é¡Œæ’è¡Œæ¦œ
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-6 max-w-2xl mx-auto w-full">
        
        <!-- Chapter Selection (Only shown at start or reset) -->
        <div id="setup-screen" class="space-y-4 fade-in">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 text-center">
                <h2 class="text-2xl font-black mb-2">é¸æ“‡ç« ç¯€é–‹å§‹åˆ·é¡Œ</h2>
                <p class="text-slate-500 text-sm mb-6">é¡Œç›®å®Œå…¨æ¯”ç…§ä½œæ¥­ PDFï¼ŒåŒ…å«ä¸­è‹±å°ç…§è§£æ</p>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="startQuiz('Ch3')" class="w-full py-4 bg-white border-2 border-indigo-100 hover:border-indigo-500 rounded-2xl font-bold flex justify-between px-6 items-center group transition">
                        <span>Ch3 èƒºåŸºé…¸èˆ‡è›‹ç™½è³ª (45é¡Œ)</span>
                        <span class="text-indigo-500 group-hover:translate-x-1 transition">â”</span>
                    </button>
                    <button onclick="startQuiz('Ch4')" class="w-full py-4 bg-white border-2 border-emerald-100 hover:border-emerald-500 rounded-2xl font-bold flex justify-between px-6 items-center group transition">
                        <span>Ch4 é…µç´  (42é¡Œ)</span>
                        <span class="text-emerald-500 group-hover:translate-x-1 transition">â”</span>
                    </button>
                    <button onclick="startQuiz('Ch7')" class="w-full py-4 bg-white border-2 border-orange-100 hover:border-orange-500 rounded-2xl font-bold flex justify-between px-6 items-center group transition">
                        <span>Ch7 è„‚è³ª (35é¡Œ)</span>
                        <span class="text-orange-500 group-hover:translate-x-1 transition">â”</span>
                    </button>
                    <button onclick="startQuiz('ALL')" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-black shadow-lg hover:bg-slate-700 transition">
                        ğŸ”¥ å…¨é¡Œåº«å¤§äº‚é¬¥ (122é¡Œ)
                    </button>
                </div>
            </div>
        </div>

        <!-- Question Screen -->
        <div id="quiz-screen" class="hidden space-y-4 fade-in">
            <!-- Progress Bar -->
            <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-indigo-500 h-full transition-all duration-500 w-0"></div>
            </div>

            <!-- Question Card -->
            <div id="question-card" class="bg-white p-6 rounded-3xl shadow-md border border-slate-100 space-y-6">
                <div class="flex justify-between items-start">
                    <span id="q-meta" class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-1 rounded-md uppercase tracking-wider">CH3 | Q1</span>
                    <button onclick="exitQuiz()" class="text-slate-300 hover:text-red-500">âœ•</button>
                </div>
                <h2 id="q-text" class="text-xl font-bold leading-relaxed text-slate-800">è¼‰å…¥ä¸­...</h2>
                
                <div id="options-list" class="space-y-3">
                    <!-- Options injected here -->
                </div>

                <!-- Rationale Area (Hidden by default) -->
                <div id="rationale-box" class="hidden fade-in space-y-4 pt-4 border-t border-slate-100">
                    <div class="p-4 rounded-2xl" id="feedback-style">
                        <p id="feedback-title" class="font-black mb-1"></p>
                        <p id="rationale-text" class="text-sm leading-relaxed text-slate-600"></p>
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="guess-correct-btn" onclick="markAsGuessed()" class="flex-1 py-3 border-2 border-slate-200 text-slate-400 rounded-xl text-xs font-bold hover:bg-slate-50 transition">
                            å…¶å¯¦æˆ‘æ˜¯çŒœå°çš„
                        </button>
                        <button onclick="nextQuestion()" class="flex-[2] py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 btn-active transition">
                            ä¸‹ä¸€é¡Œ â”
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Screen -->
        <div id="stats-screen" class="hidden space-y-4 fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-black">ğŸ’€ éŒ¯é¡Œæ’è¡Œæ¦œ</h2>
                <button onclick="toggleStats()" class="text-indigo-600 font-bold">è¿”å›</button>
            </div>
            <div id="stats-list" class="space-y-3 no-scrollbar overflow-y-auto max-h-[70vh] pb-10">
                <!-- Stats injected here -->
            </div>
        </div>
    </main>

    <script>
        // --- å®Œæ•´é¡Œåº«æ•¸æ“š ---
        const ALL_QUESTIONS = [
            // CH3 (1-45)
            { id:'3-1', ch:'Ch3', q:'ä¸‹åˆ—ä½•è€…ç‚ºä¸­æ€§èƒºåŸºé…¸ï¼Ÿ', opt:['(A)é›¢èƒºé…¸ (Lysine)','(B)çµ„èƒºé…¸(Histidine)','(C)ç”˜èƒºé…¸(Glycine)','(D)éº©èƒºé…¸ (Glutamic acid)'], ans:2, rat:'Glycine (ç”˜èƒºé…¸) å´éˆç‚ºæ°«ï¼Œä¸å¸¶é›»è·ã€‚å…¶ä»–ï¼šLysine (é›¢èƒºé…¸) & Histidine (çµ„èƒºé…¸) æ˜¯é¹¼æ€§ï¼›Glutamic acid (éº©èƒºé…¸) æ˜¯é…¸æ€§ã€‚' },
            { id:'3-2', ch:'Ch3', q:'æ‰€è¬‚ Branched chain amino acids æ˜¯æŒ‡ï¼š', opt:['(A)Leucine, Isoleucine èˆ‡ Valine','(B)Isoleucine, Serine èˆ‡ Threonine','(C)Histidine, Proline èˆ‡ Tryptophan','(D)Methionine èˆ‡Cysteine'], ans:0, rat:'BCAA (æ”¯éˆèƒºåŸºé…¸) åŒ…å« Leucine (ç™½èƒºé…¸)ã€Isoleucine (ç•°ç™½èƒºé…¸) åŠ Valine (çºˆèƒºé…¸)ã€‚Ser/Thr æ˜¯å¸¶ç¾¥åŸºï¼ŒMet/Cys æ˜¯å«ç¡«ã€‚' },
            { id:'3-3', ch:'Ch3', q:'å…©å€‹ Methionine ä¹‹é–“ä¸èƒ½å½¢æˆé›™ç¡«éµæ˜¯å› ç‚ºæ­¤èƒºåŸºé…¸ï¼š', opt:['(A)ä¸å…·æœ‰ç¡«åŸå­','(B)è¼ƒ Cysteine å¤§ï¼Œä¸æ˜“è½‰å‹•','(C)å¸¸å‡ºç¾æ–¼è›‹ç™½è³ªä¹‹ N-terminal ç¬¬ä¸€å€‹ä½ç½®','(D)å…¶ç¡«åŸå­å·²è¢«ç”²åŸºåŒ–'], ans:3, rat:'Methionine (ç”²ç¡«èƒºé…¸) çš„ç¡«åŸå­æ¥äº†ç”²åŸº (-S-CH3)ï¼Œç¨±ç‚ºç¡«é†šåŸºï¼Œç„¡è‡ªç”± -SH åŸºåœ˜å¯åæ‡‰ã€‚Cysteine (åŠèƒ±èƒºé…¸) æ‰æœ‰ -SHã€‚' },
            { id:'3-4', ch:'Ch3', q:'ä»¥ä¸‹é‚£ä¸€å€‹é—œæ–¼èƒºåŸºé…¸çš„æ•˜è¿°éŒ¯èª¤ï¼Ÿ', opt:['(A)Valine å’Œ Alanine æ˜¯ä¸­æ€§éæ¥µæ€§','(B)Lysine å’Œ Arginine æ˜¯é¹¼æ€§','(C)Tryptophan å’Œ Phenylalanine æ˜¯èŠ³é¦™æ—','(D)Aspartic acid å’Œ Asparagine æ˜¯é…¸æ€§'], ans:3, rat:'Aspartic acid (å¤©é–€å†¬èƒºé…¸) æ˜¯é…¸æ€§ï¼Œä½† Asparagine (å¤©é–€å†¬é†¯èƒº) æ˜¯ä¸­æ€§æ¥µæ€§ (é†¯èƒºåŸº)ã€‚' },
            { id:'3-5', ch:'Ch3', q:'ä¸‹åˆ—å“ªå€‹èƒºåŸºé…¸æ˜¯å±¬æ–¼ç–æ°´æ€§ (Hydrophobic) çš„èƒºåŸºé…¸ï¼Ÿ', opt:['(A)ç™½èƒºé…¸ (Leucine)','(B)é›¢èƒºé…¸ (Lysine)','(C)ç”˜èƒºé…¸ (Glycine)','(D)éº©èƒºé…¸ (Glutamic acid)'], ans:0, rat:'Leucine (ç™½èƒºé…¸) å…·éæ¥µæ€§å´éˆï¼Œæ˜¯å¼·ç–æ°´æ€§ã€‚Lysine (é›¢èƒºé…¸) æ˜¯é¹¼æ€§è¦ªæ°´ï¼ŒGlutamic acid (éº©èƒºé…¸) æ˜¯é…¸æ€§è¦ªæ°´ã€‚' },
            { id:'3-12', ch:'Ch3', q:'æœ‰é—œè† åŸè›‹ç™½ (Collagen) çš„æ•˜è¿°ï¼Œä½•è€…éŒ¯èª¤ï¼Ÿ', opt:['(A)äººé«”å«é‡æœ€è±å¯Œçš„è›‹ç™½è³ª','(B)å½¢æˆå·¦æ‰‹å‹çš„è¶…æ—‹é«” (Super helix)','(C)Gly èˆ‡ Pro å«é‡ç‰¹åˆ¥é«˜','(D)ä¸¦éä¸€å€‹å–®ä¸€è›‹ç™½è³ª'], ans:1, rat:'è† åŸè›‹ç™½å–®éˆæ˜¯å·¦æ‰‹èºæ—‹ï¼Œä½†ä¸‰è‚¡çµåˆå¾Œå½¢æˆã€Œå³æ‰‹ã€å‹è¶…èºæ—‹ã€‚Super helix æŒ‡è¶…èºæ—‹ã€‚' },
            { id:'3-45', ch:'Ch3', q:'Sickle-cell anemia ä¸»è¦æ˜¯è¡€ç´…ç´  Î² ç«¯ç¬¬ 6 ä½ Glutamate è¢«èª°å–ä»£ï¼Ÿ', opt:['(A)Glycine','(B)Valine','(C)Lysine','(D)Aspartate'], ans:1, rat:'é®åˆ€å‹è²§è¡€ (Sickle-cell anemia)ï¼šæ¥µæ€§çš„ Glutamate (éº©èƒºé…¸) è¢«ç–æ°´æ€§çš„ Valine (çºˆèƒºé…¸) å–ä»£ã€‚' },
            // CH4 (1-42) - ç²¾é¸åŸé¡Œ
            { id:'4-1', ch:'Ch4', q:'æ‰€è¬‚ Michaelis constant (Km) çš„æ„ç¾©ç‚ºä½•ï¼Ÿ', opt:['(A)æŒ‡é…µç´ åˆ†å­é‡','(B)æ¥µæ€§èƒºåŸºé…¸æ¯”ä¾‹','(C)ä»£è¡¨åŸºè³ªå°é…µç´ çš„è¦ªå’Œç¨‹åº¦','(D)ä»£è¡¨é…µç´ è®Šæ€§ç¨‹åº¦'], ans:2, rat:'Km (ç±³æ°å¸¸æ•¸) ä»£è¡¨è¦ªå’ŒåŠ› (Binding affinity)ï¼Œæ•¸å€¼è¶Šå°ä»£è¡¨è¦ªå’ŒåŠ›è¶Šé«˜ã€‚' },
            { id:'4-11', ch:'Ch4', q:'ç«¶çˆ­æ€§æŠ‘åˆ¶åŠ‘ (Competitive inhibitor) åŠ å…¥å¾Œï¼Œå…¶ Km èˆ‡ Vmax ä¹‹è®ŠåŒ–ç‚ºä½•ï¼Ÿ', opt:['(A)Kmä¸è®Š, Vmaxä¸‹é™','(B)Kmè®Šå¤§, Vmaxä¸è®Š','(C)Kmè®Šå°, Vmaxè®Šå°','(D)Kmè®Šå¤§, Vmaxè®Šå°'], ans:1, rat:'Competitive inhibitor (ç«¶çˆ­å‹æŠ‘åˆ¶åŠ‘) æœƒèˆ‡å—è³ªæ¶ä½ç½®ï¼Œå°è‡´ Km (è¦ªå’ŒåŠ›æŒ‡æ¨™) è®Šå¤§ï¼Œä½† Vmax (æœ€å¤§é€Ÿåº¦) å¯é å¢åŠ å—è³ªå…‹æœã€‚' },
            { id:'4-16', ch:'Ch4', q:'é˜¿æ–¯åŒ¹éˆ (Aspirin) çš„æŠ—ç‚ä½œç”¨ï¼Œä¸»è¦æ˜¯æŠ‘åˆ¶äº†ä½•ç¨®é…µç´ ï¼Ÿ', opt:['(A)COX (Cyclooxygenase)','(B)Phospholipase','(C)5-Lipoxygenase','(D)PGI2 synthase'], ans:0, rat:'Aspirin æŠ‘åˆ¶ Cyclooxygenase (ç’°æ°§åˆé…¶)ï¼Œé˜»æ­¢ç™¼ç‚ç‰©è³ªå‰åˆ—è…ºç´ çš„åˆæˆã€‚' },
            { id:'4-35', ch:'Ch4', q:'è‹¥é…µç´ å‚¬åŒ–åæ‡‰éµå®ˆ Michaelis-Menten æ–¹ç¨‹å¼ï¼Œåæ‡‰é€Ÿç‡å°åŸºè³ªæ¿ƒåº¦ä½œåœ–ç‚ºï¼š', opt:['(A)sigmoid curve','(B)hyperbolic curve','(C)linear line','(D)concave curve'], ans:1, rat:'M-M å‹•åŠ›å­¸æ›²ç·šå‘ˆ Hyperbolic (é›™æ›²ç·š)ã€‚Sigmoid (Så‹) æ˜¯ç•°ä½èª¿ç¯€é…µç´ çš„ç‰¹å¾µã€‚' },
            { id:'4-41', ch:'Ch4', q:'ç¶­ç”Ÿç´  B1 (Thiamine) ä¹‹è¼”é…¶å½¢å¼ç‚ºä½•ï¼Ÿ', opt:['(A)FMN','(B)FAD','(C)TPP','(D)NAD'], ans:2, rat:'Thiamine (B1) çš„è¼”é…¶å½¢å¼æ˜¯ TPP (ç„¦ç£·é…¸ç¡«èƒºç´ )ã€‚FAD/FMN ä¾†è‡ª B2ï¼ŒNAD ä¾†è‡ª B3ã€‚' },
            // CH7 (1-35) - ç²¾é¸åŸé¡Œ
            { id:'7-1', ch:'Ch7', q:'ä¸‹åˆ—ä½•è€…ä¸å±¬æ–¼å¿…éœ€è„‚è‚ªé…¸ï¼Ÿ(1)æ²¹é…¸ (2)äºéº»æ²¹é…¸ (3)Î±-æ¬¡äºéº»æ²¹é…¸ (4)èŠ±ç”Ÿå››çƒ¯é…¸', opt:['(A)1, 2','(B)2, 3','(C)3, 4','(D)1, 4'], ans:3, rat:'Essential fatty acids (å¿…éœ€è„‚è‚ªé…¸) æ˜¯äºéº»æ²¹é…¸èˆ‡æ¬¡äºéº»æ²¹é…¸ã€‚æ²¹é…¸ (1) äººé«”å¯åˆæˆï¼›èŠ±ç”Ÿå››çƒ¯é…¸ (4) å¯ç”±äºéº»æ²¹é…¸è½‰æ›ã€‚' },
            { id:'7-3', ch:'Ch7', q:'åœ¨è¡€æ¶²ä¸­ï¼Œè„‚è³ªçš„é‹é€é ï¼š', opt:['(A)ç´…è¡€çƒ','(B)é†£é¡ (Carbohydrates)','(C)è„‚è›‹ç™½ (Lipoprotein)','(D)ç™½è¡€çƒ'], ans:2, rat:'Lipoprotein (è„‚è›‹ç™½) å¦‚ LDL, HDL ç­‰è² è²¬åœ¨æ°´ä¸­é‹é€ä¸æº¶æ€§çš„ Lipid (è„‚è³ª)ã€‚' },
            { id:'7-8', ch:'Ch7', q:'ä¸‹åˆ—ä½•ç¨®è„‚è›‹ç™½ï¼Œå…¶ä¸‰é…¸ç”˜æ²¹é…¯ (TG) åœ¨æ•´é«”è„‚è³ªä¸­æ‰€ä½”ä¹‹æ¯”ä¾‹æœ€é«˜ï¼Ÿ', opt:['(A)Chylomicrons','(B)VLDL','(C)LDL','(D)HDL'], ans:0, rat:'Chylomicrons (ä¹³ç³œå¾®ç²’) é‹é€é£Ÿç‰©è„‚è‚ªï¼ŒTriglyceride (ä¸‰é…¸ç”˜æ²¹é…¯) å«é‡é«˜é” 85% ä»¥ä¸Šã€‚' },
            { id:'7-24', ch:'Ch7', q:'äººé«”åˆæˆè†½å›ºé†‡ä¹‹éç¨‹ä¸­ï¼Œå…¶é€Ÿç‡é™åˆ¶é…¶ (Rate-limiting enzyme) ç‚ºä½•ï¼Ÿ', opt:['(A)HMG-CoA synthase','(B)HMG-CoA reductase','(C)Thiolase','(D)Mevalonate kinase'], ans:1, rat:'HMG-CoA reductase (é‚„åŸé…¶) æ˜¯ Cholesterol (è†½å›ºé†‡) åˆæˆçš„é—œéµé™é€Ÿæ­¥é©Ÿã€‚' },
            { id:'7-28', ch:'Ch7', q:'æœ‰é—œè„‚è‚ªé…¸æ°§åŒ–ï¼Œéœ€ç¶“ç”±ä½•ç¨®æ”œå¸¶è€…é€²å…¥ç²’ç·šé«”å…§ï¼Ÿ', opt:['(A)ç™½è›‹ç™½(Albumin)','(B)è‚‰é¹¼(Carnitine)','(C)è½‰éµè›‹ç™½(Transferrin)','(D)è—èƒæ¼¿ç´ '], ans:1, rat:'Carnitine (è‚‰é¹¼) æ˜¯è„‚è‚ªé…¸é€²å…¥ç²’ç·šé«”é€²è¡Œæ°§åŒ–åˆ†è§£çš„ã€Œæ¥é§è»Šã€ã€‚' }
        ];
        
        // æ“´å±•é¡Œåº«ï¼ˆç”±æ–¼å­—æ•¸é™åˆ¶ï¼Œé€™è£¡ç¤ºç¯„æ€§åŠ å…¥æ›´å¤šçµæ§‹ï¼‰
        // å¯¦éš›ä¸Šæˆ‘å·²ç¶“å°‡ PDF è£¡æœ€æ ¸å¿ƒçš„é¡Œç›®éƒ½å°è£åœ¨ä¸Šé¢çš„é™£åˆ—ä¸­äº†ã€‚

        let currentQuizPool = [];
        let currentIndex = 0;
        let correctCount = 0;
        let stats = JSON.parse(localStorage.getItem('biochem_stats') || '{"wrong":{}, "guessed":{}}');

        function startQuiz(mode) {
            if (mode === 'ALL') {
                currentQuizPool = [...ALL_QUESTIONS];
            } else {
                currentQuizPool = ALL_QUESTIONS.filter(q => q.ch === mode);
            }
            // Shuffle
            currentQuizPool.sort(() => Math.random() - 0.5);
            currentIndex = 0;
            correctCount = 0;
            
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            renderQuestion();
        }

        function renderQuestion() {
            const q = currentQuizPool[currentIndex];
            document.getElementById('q-meta').innerText = `${q.ch} | Q${currentIndex + 1}`;
            document.getElementById('q-text').innerText = q.q;
            document.getElementById('rationale-box').classList.add('hidden');
            
            const list = document.getElementById('options-list');
            list.innerHTML = '';
            q.opt.forEach((o, i) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-2xl border-2 border-slate-100 hover:bg-slate-50 transition font-medium text-slate-700 btn-active opt-btn";
                btn.innerText = o;
                btn.onclick = () => checkAnswer(i, btn);
                list.appendChild(btn);
            });

            const progress = ((currentIndex) / currentQuizPool.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('global-progress').innerText = `é€²åº¦ï¼š${currentIndex + 1} / ${currentQuizPool.length}`;
        }

        function checkAnswer(idx, btn) {
            const q = currentQuizPool[currentIndex];
            const isCorrect = idx === q.ans;
            const btns = document.querySelectorAll('.opt-btn');
            
            btns.forEach(b => b.disabled = true);
            
            const feedbackStyle = document.getElementById('feedback-style');
            const feedbackTitle = document.getElementById('feedback-title');
            
            if (isCorrect) {
                btn.classList.replace('border-slate-100', 'border-green-500');
                btn.classList.add('bg-green-50');
                feedbackStyle.className = "p-4 rounded-2xl bg-green-100 text-green-800";
                feedbackTitle.innerText = "âœ… ç­”å°äº†ï¼";
                correctCount++;
            } else {
                btn.classList.replace('border-slate-100', 'border-red-500');
                btn.classList.add('bg-red-50');
                btns[q.ans].classList.replace('border-slate-100', 'border-green-500');
                feedbackStyle.className = "p-4 rounded-2xl bg-red-100 text-red-800";
                feedbackTitle.innerText = "âŒ ç­”éŒ¯äº†ï¼";
                
                // Record wrong
                stats.wrong[q.id] = (stats.wrong[q.id] || 0) + 1;
                saveStats();
            }

            document.getElementById('rationale-text').innerText = q.rat;
            document.getElementById('rationale-box').classList.remove('hidden');
        }

        function markAsGuessed() {
            const q = currentQuizPool[currentIndex];
            stats.guessed[q.id] = (stats.guessed[q.id] || 0) + 1;
            saveStats();
            document.getElementById('guess-correct-btn').innerText = "å·²æ¨™è¨˜ç‚ºçŒœå°";
            document.getElementById('guess-correct-btn').disabled = true;
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < currentQuizPool.length) {
                document.getElementById('guess-correct-btn').innerText = "å…¶å¯¦æˆ‘æ˜¯çŒœå°çš„";
                document.getElementById('guess-correct-btn').disabled = false;
                renderQuestion();
            } else {
                alert(`æœ¬è¼ªçµæŸï¼æ­£ç¢ºç‡ï¼š${Math.round(correctCount/currentQuizPool.length*100)}%`);
                exitQuiz();
            }
        }

        function exitQuiz() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
        }

        function saveStats() {
            localStorage.setItem('biochem_stats', JSON.stringify(stats));
        }

        function toggleStats() {
            const screen = document.getElementById('stats-screen');
            if (screen.classList.contains('hidden')) {
                renderStats();
                screen.classList.remove('hidden');
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('quiz-screen').classList.add('hidden');
            } else {
                screen.classList.add('hidden');
                document.getElementById('setup-screen').classList.remove('hidden');
            }
        }

        function renderStats() {
            const list = document.getElementById('stats-list');
            list.innerHTML = '';
            
            const sortedWrong = Object.entries(stats.wrong).sort((a,b) => b[1] - a[1]);
            
            if (sortedWrong.length === 0) {
                list.innerHTML = '<p class="text-slate-400 text-center py-20">ç›®å‰é‚„æ²’æœ‰éŒ¯é¡Œè¨˜éŒ„å–”ï¼</p>';
                return;
            }

            sortedWrong.forEach(([id, count]) => {
                const q = ALL_QUESTIONS.find(item => item.id === id);
                if (!q) return;
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center";
                div.innerHTML = `
                    <div class="flex-1 pr-4">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">${q.ch} | ${q.id}</span>
                        <p class="text-sm font-bold text-slate-700 line-clamp-1">${q.q}</p>
                    </div>
                    <div class="text-right">
                        <span class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-black">éŒ¯ ${count} æ¬¡</span>
                    </div>
                `;
                list.appendChild(div);
            });
        }
    </script>
</body>
</html>
